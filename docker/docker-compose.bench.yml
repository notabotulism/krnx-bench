# KRNX Benchmark Docker Compose
# ==============================
#
# ISOLATED PORTS: Uses 16xxx range to avoid conflicts with local development
#   - Redis: 16379 (not 6379)
#   - KRNX:  16380 (not 6380)
#   - Qdrant: 16333 (not 6333)
#
# Usage:
#   docker compose -f docker/docker-compose.bench.yml up -d
#   docker compose -f docker/docker-compose.bench.yml down
#
# Note: The benchmark harness manages these containers automatically.
# This file is provided for manual testing and debugging.

services:
  # Redis (for KRNX STM) - ISOLATED PORT
  redis:
    image: redis:7-alpine
    container_name: krnx-bench-redis
    ports:
      - "16379:6379"  # Host 16379 -> Container 6379
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - krnx-bench

  # KRNX Server - ISOLATED PORT
  krnx:
    image: krnx:latest
    container_name: krnx-bench-server
    ports:
      - "16380:6380"  # Host 16380 -> Container 6380
    environment:
      # NOTE: KRNX uses REDIS_HOST/REDIS_PORT, not REDIS_URL
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DATABASE_PATH=/app/data/krnx.db
      - LOG_LEVEL=INFO
    volumes:
      - krnx-data:/app/data
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6380/api/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - krnx-bench

  # Qdrant (for Naive RAG baseline) - ISOLATED PORT
  qdrant:
    image: qdrant/qdrant:latest
    container_name: krnx-bench-qdrant
    ports:
      - "16333:6333"  # Host 16333 -> Container 6333
      - "16334:6334"  # gRPC
    volumes:
      - qdrant-data:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - krnx-bench

networks:
  krnx-bench:
    driver: bridge
    name: krnx-bench-network

volumes:
  redis-data:
  krnx-data:
  qdrant-data:
